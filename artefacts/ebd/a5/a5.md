# A5: Relational Schema, validation and schema refinement

This artifact contains the Relational Schema obtained by mapping from the Conceptual Data Model. The Relational Schema includes the relation schema, attributes, domains, primary keys, foreign keys and other integrity rules: UNIQUE, DEFAULT, NOT NULL, CHECK.

## 1. Relational Schema

Relation schemas are specified in the compact notation:

| Relation reference | Relation Compact Notation                                            |
| ------------------ | -------------------------------------------------------------------- |
| R01 | member(<ins>id</ins>, username **UK** **NN**, full_name **NN**, email **UK** **NN**, password **NN**, bio, profile_img, banner_img, aura **NN** **DF** = 0) |
| R02 | member_follow(<ins>id_follower</ins> → member, <ins>id_followed</ins> → member) |
| R03 | administrator(<ins>id</ins> → member) |
| R04 | news_post(<ins>id</ins>, title **NN**, body, post_date **NN**, aura **NN**, <ins>owner</ins> → member) |
| R05 | topic(<ins>id</ins>, name **UK** **NN**) |
| R06 | topic_follow(<ins>id_topic</ins> → topic, <ins>id_member</ins> → member ) |
| R07 | post_topics(<ins>id_post</ins> → news_post, <ins>id_topic</ins> → topic ) |
| R08 | comment(<ins>id</ins>, body **NN**, commentDate **NN**, <ins>id_post</ins> → news_post) |
| R09 | reply(<ins>id_comment</ins> → comment, id_parent → comment) |
| R10 | post_images(<ins>id_post</ins> → news_post, <ins>file</ins>**UK** **NN**) |
| R11 | post_aura(<ins>id_post</ins> → news_post, <ins>id_voter</ins> → member, upvote **NN**) |                  
| R12 | comment_aura(<ins>id_comment</ins> → Comment, <ins>id_voter</ins> → member, upvote) |
| R13 | follow_notification(<ins>id_follower</ins> → member, <ins>id_followed</ins> → member) |
| R14 | comment_notification(<ins>id_comment</ins> → comment, <ins>id_commenter</ins> → member, body **NN**) |
| R15 | reply_notification(<ins>id_reply</ins> → reply, <ins>id_commenter</ins> → member, body **NN**) |
| R16 | post_report(<ins>id_reporter</ins> → member, <ins>id_post</ins> → news_post, body **NN**) |
| R17 | comment_report(<ins>id_reporter</ins> → member, <ins>id_comment</ins> → comment, body **NN**) |
| R18 | topic_report(<ins>id_reporter</ins> → member, <ins>id_topic</ins> → topic, body **NN**) | 
| R19 | member_report(<ins>id_reporter</ins> → member, <ins>id_reported</ins> → member, body **NN** |

**Note:** UK means UNIQUE KEY, NN means NOT NULL, DF means DEFAULT and CK means CHECK.


## 2. Domains

The specification of additional domains can also be made in a compact form, using the notation:

| Domain Name | Domain Specification |
| ----------- | -------------------- |
| Now | TIMESTAMP DEFAULT CURRENT_TIMESTAMP() |


## 3. Functional Dependencies and schema validation

To validate the Relational Schema obtained from the Conceptual Model, all functional dependencies are identified and the normalization of all relation schemas is accomplished.

| Table R01  (member)   |    |
| ---- | ---- |
| **Keys** | {id}, {username}, {email} |
| FD0101 | {id}:- {username, full_name ,email, password, bio, profile_img, banner_img, aura} | 
| FD0102 | {username}:- {id, full_name ,email, password, bio, profile_img, banner_img, aura} |
| FD0103 | {email}:- {id, username, full_name, password, bio, profile_img, banner_img, aura} |
| **Normal form** | BCNF |

| Table R02  (member_follow)   |    |
| ---- | ---- |
| **Keys** | {id_memberFolllows, id_member_followed} |
| **Normal form** | BCNF |

| Table R03  (administrator)   |    |
| ---- | ---- |
| **Keys** | {id_member} |
| **Normal form** | BCNF |

| Table R04  (news_post)   |    |
| ---- | ---- |
| **Keys** | {id} |
| FD0401 | {id}:- {title , body, date , aura , owner} | 
| **Normal form** | BCNF |

| Table R05  (topic)   |    |
| ---- | ---- |
| **Keys** | {id} |
| FD0501 | {id}:- {title , body, date , aura , owner} | 
| **Normal form** | BCNF |

| Table R06  (topic_follow)   |    |
| ---- | ---- |
| **Keys** | {id_topic, id_member} |
| **Normal form** | BCNF |

| Table R07  (post_topics)   |    |
| ---- | ---- |
| **Keys** | {id_post, id_topic} |
| **Normal form** | BCNF |

| Table R08  (comment)   |    |
| ---- | ---- |
| **Keys** | {id} |
| FD0801 | {id}:- {body, commentDate, id_post} | 
| **Normal form** | BCNF |

| Table R09  (reply)   |    |
| ---- | ---- |
| **Keys** | {id_comment} |
| FD0901 | {id_comment}:- {id_parent} | 
| **Normal form** | BCNF |

| Table R10  (post_images)   |    |
| ---- | ---- |
| **Keys** | {id_post, file} |
| **Normal form** | BCNF |

| Table R11  (post_aura)   |    |
| ---- | ---- |
| **Keys** | {id_post, id_voter} |
| FD1101 | {id_post, id_voter}:- {upvote} | 
| **Normal form** | BCNF |

| Table R12  (comment_aura)   |    |
| ---- | ---- |
| **Keys** | {id_comment, id_voter}  |
| FD1201 | {id_comment, id_voter}:- {upvote} | 
| **Normal form** | BCNF |

| Table R13  (follow_notification)   |    |
| ---- | ---- |
| **Keys** | {id_follower, id_followed} |
| **Normal form** | BCNF |

| Table R14  (comment_notification)   |    |
| ---- | ---- |
| **Keys** | {id_comment, id_commenter} |
| FD1401 | {id_comment, id_commenter}:- {body} | 
| **Normal form** | BCNF |

| Table R15  (reply_notification)   |    |
| ---- | ---- |
| **Keys** | {id_reply, id_commenter} |
| FD1501 | {id_reply, id_commenter}:- {body} | 
| **Normal form** | BCNF |

| Table R16  (post_report)   |    |
| ---- | ---- |
| **Keys** | {id_reporter, id_post} |
| FD1601 | {id_reporter, id_post}:- {body} | 
| **Normal form** | BCNF |

| Table R17  (comment_report)   |    |
| ---- | ---- |
| **Keys** | {id_reporter, id_comment} |
| FD1701 | {id_reporter, id_comment}:- {body} | 
| **Normal form** | BCNF |

| Table R18  (topic_report)   |    |
| ---- | ---- |
| **Keys** | {id_reporter, id_topic} |
| FD1801 | {id_reporter, id_topic}:- {body} | 
| **Normal form** | BCNF |

| Table R19  (member_report)   |    |
| ---- | ---- |
| **Keys** | {id_reporter, id_reported} |
| FD1901 | {id_reporter, id_reported}:- {body} | 
| **Normal form** | BCNF |


As all relations schemas are in the Boyce–Codd Normal Form (BCNF), the relational schema is also in the BCNF and therefore there is no need to be refined using normalisation.


## 4. SQL Code

```sql
DROP TABLE IF EXISTS member CASCADE;
DROP TABLE IF EXISTS member_follow CASCADE;
DROP TABLE IF EXISTS administrator CASCADE;
DROP TABLE IF EXISTS news_post CASCADE;
DROP TABLE IF EXISTS topic CASCADE;
DROP TABLE IF EXISTS topic_follow CASCADE;
DROP TABLE IF EXISTS post_topics CASCADE;
DROP TABLE IF EXISTS comment CASCADE;
DROP TABLE IF EXISTS reply CASCADE;
DROP TABLE IF EXISTS post_images CASCADE;
DROP TABLE IF EXISTS post_aura CASCADE;
DROP TABLE IF EXISTS comment_aura CASCADE;
DROP TABLE IF EXISTS follow_notification CASCADE;
DROP TABLE IF EXISTS comment_notification CASCADE;
DROP TABLE IF EXISTS reply_notification CASCADE;
DROP TABLE IF EXISTS post_report CASCADE;
DROP TABLE IF EXISTS comment_report CASCADE;
DROP TABLE IF EXISTS topic_report CASCADE;
DROP TABLE IF EXISTS member_report CASCADE;


CREATE TABLE member (
    id integer PRIMARY KEY,
    username text NOT NULL UNIQUE,
    full_name text NOT NULL,
    email text NOT NULL UNIQUE,
    password text NOT NULL,
    bio text,
    profile_img bytea,
    banner_img bytea,
    aura integer DEFAULT 0 NOT NULL
);

CREATE TABLE member_follow (
    id_follower integer REFERENCES member(id) ON DELETE CASCADE,
    id_followed integer REFERENCES member(id) ON DELETE CASCADE,
    PRIMARY KEY(id_follower, id_followed)
);

CREATE TABLE administrator (
    id integer PRIMARY KEY REFERENCES member(id)
);

CREATE TABLE news_post (
    id integer PRIMARY KEY,
    title text NOT NULL,
    body text,
    post_date timestamp NOT NULL,
    aura integer DEFAULT 0 NOT NULL,
    owner integer NOT NULL REFERENCES member(id) ON DELETE CASCADE
);

CREATE TABLE topic (
    id integer PRIMARY KEY,
    name text NOT NULL UNIQUE
);

CREATE TABLE topic_follow (
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    id_member integer REFERENCES member(id) ON DELETE CASCADE,
    PRIMARY KEY(id_topic, id_member)
);

CREATE TABLE post_topics (
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    PRIMARY KEY(id_post, id_topic)
);

CREATE TABLE comment (
    id integer PRIMARY KEY,
    body text NOT NULL,
    commentDate timestamp NOT NULL,
    aura integer DEFAULT 0 NOT NULL,
    id_post integer NOT NULL REFERENCES news_post(id) ON DELETE CASCADE
);

CREATE TABLE reply (
    id_comment integer PRIMARY KEY REFERENCES comment(id) ON DELETE CASCADE,
    id_parent integer REFERENCES comment(id) ON DELETE CASCADE
);

CREATE TABLE post_images (
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    file bytea,
    PRIMARY KEY(id_post, file)
);

CREATE TABLE post_aura (
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    id_voter integer REFERENCES member(id) ON DELETE CASCADE,
    upvote boolean NOT NULL,
    PRIMARY KEY(id_post, id_voter)
);

CREATE TABLE comment_aura (
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    id_voter integer REFERENCES member(id) ON DELETE CASCADE,
    upvote boolean NOT NULL,
    PRIMARY KEY(id_comment, id_voter)
);

CREATE TABLE follow_notification (
    id_follower integer REFERENCES member(id) ON DELETE CASCADE,
    id_followed integer REFERENCES member(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_follower, id_followed)
);

CREATE TABLE comment_notification (
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    id_commenter integer REFERENCES member(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_comment, id_commenter)
);

CREATE TABLE reply_notification (
    id_reply integer REFERENCES reply(id_comment) ON DELETE CASCADE,
    id_commenter integer REFERENCES member(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_reply, id_commenter)
);

CREATE TABLE post_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_post integer REFERENCES news_post(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_reporter, id_post)
);

CREATE TABLE comment_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_comment integer REFERENCES comment(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_reporter, id_comment)
);

CREATE TABLE topic_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_topic integer REFERENCES topic(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_reporter, id_topic)
);

CREATE TABLE member_report (
    id_reporter integer REFERENCES member(id) ON DELETE SET NULL,
    id_reported integer REFERENCES member(id) ON DELETE CASCADE,
    body text NOT NULL,
    PRIMARY KEY(id_reporter, id_reported)
);
```


***
## Revision history

Changes made to the first submission:  N/A

***
GROUP2133, 16/03/2021